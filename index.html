<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Morikawa NY 2026</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { 
      margin:0; 
      padding:0; 
      background:#000 url('https://images.alphacoders.com/100/1006380.jpg') center/cover fixed no-repeat; 
      color:white; 
      font-family:'Noto Sans JP',sans-serif; 
      overflow:hidden; 
      height:100vh;
    }
    #snow { 
      position:fixed; 
      top:0; left:0; 
      width:100%; height:100%; 
      pointer-events:none; 
      opacity:0.5; 
      background:url('https://media.tenor.com/cPBQj33Iu-YAAAAM/cherry-blossom-anime.gif') center/cover fixed; 
      mix-blend-mode:screen; 
    }

    .container { 
      position:relative; 
      z-index:10; 
      text-align:center; 
      padding:4vh 5vw; 
      display:none; 
      backdrop-filter: blur(8px); 
      background:rgba(0,0,0,0.5); 
      border-radius:20px; 
      margin:3vh 3vw; 
      box-shadow:0 0 20px rgba(255,105,180,0.3); 
      max-height:85vh;
      overflow-y:auto;
    }
    .active { display:block; }

    /* –ú–æ–±–∏–ª—å–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
    h1 { font-size:9vw; margin:5vh 0; text-shadow:0 0 20px #ff1493; color:#ff69b4; }
    .countdown { font-size:6vw; margin:6vh 0; color:#ff69b4; text-shadow:0 0 12px #ff1493; }
    #game { width:90vw; height:90vw; max-width:360px; max-height:360px; margin:6vh auto; position:relative; background:rgba(255,105,180,0.15); border-radius:40px; overflow:hidden; border:4px solid #ff69b4; box-shadow:0 0 30px #ff1493; }
    .kadzyun { position:absolute; width:20vw; height:20vw; max-width:80px; max-height:80px; background:url('https://i.imgur.com/0Z9kZ0j.png') center/cover; cursor:pointer; animation:fadeIn 0.5s, glow 1.5s infinite alternate; }
    @keyframes glow { from { box-shadow:0 0 15px #ff69b4; } to { box-shadow:0 0 30px #ff1493; } }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    .score { font-size:6.5vw; margin:4vh; color:#ffd700; text-shadow:0 0 15px gold; }
    .buttons { margin:8vh 0; }
    button { background:linear-gradient(#ff1493, #ff69b4); border:none; color:white; padding:4vh 8vw; margin:3vh; border-radius:25px; font-size:5.5vw; cursor:pointer; box-shadow:0 0 25px #ff69b4; transition:0.5s; min-height:12vh; }
    button:active { transform:scale(1.1); }
    .top { margin:6vh; font-size:5vw; background:rgba(0,0,0,0.7); padding:5vh; border-radius:25px; }
    nav { position:fixed; bottom:0; left:0; width:100%; display:flex; justify-content:space-around; background:rgba(0,0,0,0.8); padding:3vh; backdrop-filter: blur(15px); z-index:20; }
    nav button { flex:1; margin:2vw; padding:3vh; font-size:4.5vw; background:#ff1493; box-shadow:0 0 20px #ff69b4; }

    #case-model { width:70vw; height:70vw; max-width:280px; max-height:280px; margin:8vh auto; background:url('https://png.pngtree.com/png-vector/20200214/ourlarge/pngtree-japanese-red-envelope-with-sakura-branch-and-cherry-blossom-vector-png-image_2143468.jpg') center/cover; cursor:pointer; transition:0.6s; border-radius:40px; box-shadow:0 0 40px #ff1493; position:relative; overflow:hidden; }
    #case-model::after { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:url('https://media.giphy.com/media/26uf1q4rdoKq2wRJC/giphy.gif') center/cover; opacity:0; transition:0.6s; mix-blend-mode:screen; }
    #case-model:hover::after { opacity:0.4; }
    #case-model.opening { animation: shakeOpen 2s ease-in-out; }
    @keyframes shakeOpen {
      0% { transform: scale(1) rotate(0); }
      20% { transform: scale(1.15) rotate(-12deg); box-shadow: 0 0 60px #ff1493; }
      50% { transform: scale(1.4); opacity: 0.6; }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }

    #drop-animation { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90vw; height:70vh; max-width:360px; max-height:500px; display:none; z-index:30; animation:revealCard 1.2s ease-out; }
    @keyframes revealCard { from {opacity:0; transform:scale(0.4) translate(-50%,-50%);} to {opacity:1; transform:scale(1) translate(-50%,-50%);} }
    .card-display { width:100%; height:100%; background:rgba(0,0,0,0.7); border:6px solid gold; border-radius:30px; padding:5vw; text-align:center; box-shadow:0 0 50px #ffd700; position:relative; overflow:hidden; }
    .rarity-common { border-color:#bbb; }
    .rarity-rare { border-color:#00ff00; }
    .rarity-epic { border-color:#ff00ff; box-shadow:0 0 60px #ff00ff; }
    .card-img { width:70vw; height:70vw; max-width:260px; max-height:260px; object-fit:cover; border-radius:20px; margin:8vw 0; box-shadow:0 0 30px #ff69b4; }
    #collection { display:grid; grid-template-columns:repeat(2,1fr); gap:4vw; margin:6vw; padding:3vw; }
    .collected-card { width:100%; padding-bottom:133%; background-size:cover; background-position:center; border-radius:15px; opacity:0.7; box-shadow:0 0 15px #000; transition:0.5s; position:relative; }
    .collected-card.owned { opacity:1; box-shadow:0 0 30px gold; transform:scale(1.05); animation: pulse 3s infinite; }
    @keyframes pulse { 0% { transform:scale(1.05); } 50% { transform:scale(1.15); } 100% { transform:scale(1.05); } }
    .confetti { position:absolute; width:15px; height:15px; background:#ff69b4; border-radius:50%; animation:confettiFall 4s linear infinite; opacity:0.8; }
    @keyframes confettiFall { 0% {transform:translateY(-150%) rotate(0deg);} 100% {transform:translateY(150vh) rotate(720deg);} }
    #daily-info { font-size:6vw; margin:8vw; padding:5vw; background:rgba(255,20,147,0.4); border-radius:30px; box-shadow:0 0 25px #ff69b4; }

    /* –ü–ö –≤–µ—Ä—Å–∏—è */
    @media (min-width: 768px) {
      h1 { font-size:4vw; }
      .countdown { font-size:3vw; }
      #game { width:400px; height:400px; }
      button { font-size:2vw; padding:1.5vh 3vw; margin:1vh; }
      nav { position:fixed; left:0; top:0; width:180px; height:100vh; flex-direction:column; padding:5vh 0; }
      nav button { width:80%; margin:2vh auto; font-size:1.8vw; padding:2vh; }
      .container { margin-left:200px; padding:3vh 4vw; }
      #collection { grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:30px; }
      #case-model { width:300px; height:300px; }
      #daily-info { font-size:2.2vw; }
      .top { font-size:1.8vw; }
      .buttons button { font-size:1.8vw; padding:1.5vh 3vw; }
    }

    /* Lo-Fi –ø–ª–µ–µ—Ä —É–ª—É—á—à–µ–Ω–Ω—ã–π */
    #lofi-container { 
      position:fixed; 
      bottom:20px; 
      right:20px; 
      z-index:50; 
      background:rgba(0,0,0,0.6); 
      border-radius:25px; 
      padding:15px; 
      box-shadow:0 0 30px rgba(255,105,180,0.5); 
      backdrop-filter: blur(15px); 
      transition:0.5s; 
      opacity:0.8;
      display:none;
    }
    #lofi-container:hover { opacity:1; transform:scale(1.05); box-shadow:0 0 40px rgba(255,105,180,0.8); }
    #lofi-player iframe { width:280px; height:160px; border-radius:20px; border:none; }
    #lofi-toggle { 
      position:fixed; 
      bottom:20px; 
      right:20px; 
      z-index:51; 
      background:linear-gradient(#ff1493, #ff69b4); 
      color:white; 
      border:none; 
      width:70px; 
      height:70px; 
      border-radius:50%; 
      font-size:35px; 
      cursor:pointer; 
      box-shadow:0 0 30px #ff69b4; 
      transition:0.5s; 
      display:flex; 
      align-items:center; 
      justify-content:center;
    }
    #lofi-toggle:hover { transform:scale(1.15); box-shadow:0 0 50px #ff1493; }
    #lofi-toggle:active { transform:scale(0.95); }

    @media (min-width: 768px) {
      #lofi-player iframe { width:350px; height:200px; }
      #lofi-toggle { width:80px; height:80px; font-size:40px; bottom:30px; right:30px; }
      #lofi-container { bottom:30px; right:30px; padding:20px; }
    }
  </style>
</head>
<body>
  <div id="snow"></div>

  <!-- Lo-Fi –ø–ª–µ–µ—Ä -->
  <div id="lofi-container">
    <iframe id="lofi-iframe" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&mute=1&loop=1&playlist=jfKfPfyJRdk" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>
  <button id="lofi-toggle" onclick="toggleLofi()">üå∏üé∂</button>

  <div id="home" class="container active">
    <h1>üå∏ Morikawa<br>–ù–æ–≤—ã–π –≥–æ–¥ 2026 ‚õ©Ô∏è</h1>
    <div class="countdown" id="countdown"></div>
    <p>–ü–æ–π–º–∞–π –∫–∞–¥–∑—é–Ω—ã! üßß</p>
    <div class="score">–û—á–∫–∏: <span id="score">0</span></div>
    <div id="game"></div>
    <div class="top" id="top">–¢–æ–ø —Å–µ–≥–æ–¥–Ω—è: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
    <div class="buttons">
      <button onclick="Telegram.WebApp.openLink('https://forms.gle/BE1kb2Hk94wk6ph87')">üéç –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      <button onclick="copyCoords()">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: —Ä–æ–∑–æ–≤–∞—è 1700</button>
      <button onclick="Telegram.WebApp.close()">‚ú® –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="leaderboard" class="container">
    <h1>üèÜ –õ–∏–¥–µ—Ä—ã –ø–æ –∫–∞–¥–∑—é–Ω–∞–º</h1>
    <div class="top" id="leader-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button onclick="switchPage('home')">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="cards" class="container">
    <h1>üé≤ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∫–µ–π—Å—ã Morikawa</h1>
    <div id="daily-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="case-model" onclick="openCase(false)"></div>
    <button onclick="openCase(true)">–û—Ç–∫—Ä—ã—Ç—å –∑–∞ 100 –º–æ–Ω–µ—Ç üå∏</button>

    <div id="drop-animation">
      <div class="card-display" id="dropped-card">
        <h2 id="card-name"></h2>
        <div id="card-rarity"></div>
        <img id="card-image" class="card-img" src="">
        <p id="card-desc"></p>
        <button onclick="closeDrop()">–ó–∞–±—Ä–∞—Ç—å!</button>
      </div>
    </div>

    <h2>–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</h2>
    <div id="collection">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <button onclick="switchPage('home')">–ù–∞–∑–∞–¥</button>
  </div>

  <nav>
    <button onclick="switchPage('home')">–ì–ª–∞–≤–Ω–∞—è</button>
    <button onclick="switchPage('leaderboard')">–õ–∏–¥–µ—Ä—ã</button>
    <button onclick="switchPage('cards')">–ö–µ–π—Å—ã</button>
  </nav>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const pb = new PocketBase('http://127.0.0.1:8090'); // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL

    let currentPlayer = null;
    let score = 0;

    // Lo-Fi –ø–ª–µ–µ—Ä
    function toggleLofi() {
      const container = document.getElementById('lofi-container');
      const toggle = document.getElementById('lofi-toggle');
      const iframe = document.getElementById('lofi-iframe');
      if (container.style.display === 'none') {
        container.style.display = 'block';
        toggle.innerHTML = 'üîäüå∏';
        iframe.src = iframe.src.replace('&mute=1', '&mute=0&volume=50');
      } else {
        container.style.display = 'none';
        toggle.innerHTML = 'üå∏üé∂';
      }
    }

    // –õ–µ–ø–µ—Å—Ç–∫–∏
    const canvas = document.getElementById('snow');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let particles = [];
    for(let i=0; i<100; i++) {
      particles.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: Math.random()*4+1,
        d: Math.random()*100,
        type: 'sakura'
      });
    }
    function drawParticles() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#ff69b4';
      for(let i=0; i<particles.length; i++) {
        let p = particles[i];
        ctx.fillRect(p.x, p.y, p.r*2.5, p.r*3.5);
        p.y += p.r/1.5;
        if(p.y > canvas.height) p.y = 0;
        p.x += Math.sin(p.d/10);
      }
      requestAnimationFrame(drawParticles);
    }
    drawParticles();

    // –û—Ç—Å—á—ë—Ç
    function updateCountdown() {
      const now = new Date();
      const ny = new Date('2026-01-01T00:00:00');
      const diff = ny - now;
      if(diff <= 0) return document.getElementById('countdown').innerHTML = 'üéâ –° –ù–æ–≤—ã–º 2026 –≥–æ–¥–æ–º! üéâ';
      const days = Math.floor(diff / (1000*60*60*24));
      const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
      const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
      const secs = Math.floor((diff % (1000*60)) / 1000);
      document.getElementById('countdown').innerHTML = `${days}–¥ ${hours}—á ${mins}–º ${secs}—Å –¥–æ –ù–æ–≤–æ–≥–æ –≥–æ–¥–∞! üéÜ`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // –ö–∞–¥–∑—é–Ω—ã
    const game = document.getElementById('game');
    function spawnKadzyun() {
      const k = document.createElement('div');
      k.className = 'kadzyun';
      k.style.left = Math.random()* (game.offsetWidth - 80) + 'px';
      k.style.top = Math.random()* (game.offsetHeight - 80) + 'px';
      k.onclick = () => {
        score += 10;
        document.getElementById('score').textContent = score;
        saveLocalScore();
        k.remove();
      };
      game.appendChild(k);
      setTimeout(() => k && k.remove(), 3000);
    }
    setInterval(spawnKadzyun, 800);

    // –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø
    function saveLocalScore() {
      const user = Telegram.WebApp.initDataUnsafe.user || {first_name:'–ê–Ω–æ–Ω–∏–º'};
      const name = user.username ? `@${user.username}` : user.first_name;
      const today = new Date().toDateString();
      let top = JSON.parse(localStorage.getItem('morikawa_kadzyun_top') || '{}');
      if(!top[today]) top[today] = [];
      const existing = top[today].find(p => p.name === name);
      if(existing) existing.score = Math.max(existing.score, score);
      else top[today].push({name, score});
      top[today].sort((a,b)=>b.score-a.score);
      top[today] = top[today].slice(0,10);
      localStorage.setItem('morikawa_kadzyun_top', JSON.stringify(top));
      updateLocalTop();
    }
    function updateLocalTop() {
      const today = new Date().toDateString();
      let top = JSON.parse(localStorage.getItem('morikawa_kadzyun_top') || '{}');
      const list = top[today] || [];
      document.getElementById('top').innerHTML = '<strong>üèÜ –¢–æ–ø —Å–µ–≥–æ–¥–Ω—è:</strong><br>' + 
        (list.length ? list.map((p,i)=>`${i+1}. ${p.name} ‚Äî ${p.score}`).join('<br>') : '–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∏–≥—Ä–∞–ª!');
    }
    updateLocalTop();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞
    async function initPlayer() {
      const tg = Telegram.WebApp.initDataUnsafe;
      if (!tg.user || !tg.user.id) {
        Telegram.WebApp.showAlert('–ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ Telegram!');
        return;
      }

      try {
        currentPlayer = await pb.collection('players').getFirstListItem(`telegram_id = ${tg.user.id}`);
      } catch (e) {
        currentPlayer = await pb.collection('players').create({
          telegram_id: tg.user.id,
          username: tg.user.username || tg.user.first_name || '–ê–Ω–æ–Ω–∏–º',
          coins: 100,
          free_cases_today: 0,
        });
      }

      document.getElementById('daily-info').innerHTML = `
        üå∏ –ú–æ–Ω–µ—Ç—ã: <strong>${currentPlayer.coins}</strong> 
        | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å: <strong>${currentPlayer.free_cases_today < 1 ? '–î–æ—Å—Ç—É–ø–µ–Ω!' : '–°–µ–≥–æ–¥–Ω—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}</strong>
      `;

      await loadCollection();
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞
    async function openCase(paid = false) {
      if (!currentPlayer) return;

      const today = new Date().toISOString().slice(0,10);

      if (!paid && currentPlayer.free_cases_today >= 1) {
        return Telegram.WebApp.showAlert('–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —Å–µ–≥–æ–¥–Ω—è!');
      }
      if (paid && currentPlayer.coins < 100) {
        return Telegram.WebApp.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –ù—É–∂–Ω–æ 100 üå∏');
      }

      const caseModel = document.getElementById('case-model');
      caseModel.classList.add('opening');
      setTimeout(async () => {
        caseModel.classList.remove('opening');

        const cards = await pb.collection('cards').getFullList();
        const total = cards.reduce((s, c) => s + c.drop_weight, 0);
        let rand = Math.random() * total;
        let drop = null;
        for (let c of cards) {
          rand -= c.drop_weight;
          if (rand <= 0) { drop = c; break; }
        }

        try {
          await pb.collection('player_cards').create({
            player: currentPlayer.id,
            card: drop.id,
          });
        } catch (e) {}

        const updates = {};
        if (paid) updates.coins = currentPlayer.coins - 100;
        if (!paid) {
          updates.free_cases_today = 1;
          updates.last_free_case = today;
        }
        currentPlayer = await pb.collection('players').update(currentPlayer.id, updates);

        document.getElementById('card-name').textContent = drop.name + (drop.username ? ` (${drop.username})` : '');
        document.getElementById('card-rarity').textContent = drop.rarity.toUpperCase();
        document.getElementById('card-rarity').style.color = drop.rarity === 'epic' ? '#ff00ff' : drop.rarity === 'rare' ? '#00ff00' : '#bbb';
        document.getElementById('card-image').src = drop.image_url || 'https://via.placeholder.com/260?text=No+Image';
        document.getElementById('card-desc').textContent = drop.description || '';
        document.getElementById('dropped-card').className = `card-display rarity-${drop.rarity}`;
        document.getElementById('drop-animation').style.display = 'block';

        for(let i=0; i<80; i++) {
          const conf = document.createElement('div');
          conf.className = 'confetti';
          conf.style.left = Math.random()*360 + 'px';
          conf.style.background = ['#ff69b4', '#ffd700', '#ff1493'][Math.floor(Math.random()*3)];
          conf.style.animationDelay = Math.random()*0.5 + 's';
          document.getElementById('dropped-card').appendChild(conf);
          setTimeout(() => conf.remove(), 4000);
        }

        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        document.getElementById('daily-info').innerHTML = `
          üå∏ –ú–æ–Ω–µ—Ç—ã: <strong>${currentPlayer.coins}</strong> 
          | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å: <strong>–°–µ–≥–æ–¥–Ω—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</strong>
        `;
        await loadCollection();
      }, 2000);
    }

    function closeDrop() {
      document.getElementById('drop-animation').style.display = 'none';
    }

    async function loadCollection() {
      if (!currentPlayer) return;

      const records = await pb.collection('player_cards').getList(1, 100, {
        filter: `player = "${currentPlayer.id}"`,
        expand: 'card',
      });

      const allCards = await pb.collection('cards').getFullList();
      const collectionEl = document.getElementById('collection');
      collectionEl.innerHTML = `<h3>–ö–æ–ª–ª–µ–∫—Ü–∏—è: ${records.items.length} / ${allCards.length}</h3>`;

      allCards.forEach(card => {
        const div = document.createElement('div');
        div.className = 'collected-card';
        const owned = records.items.some(r => r.expand.card.id === card.id);
        if (owned) div.classList.add('owned');
        div.style.backgroundImage = `url('${card.image_url || 'https://via.placeholder.com/180?text=' + card.name}')`;
        div.title = `${card.name} (${card.rarity})`;
        collectionEl.appendChild(div);
      });
    }

    function switchPage(page) {
      document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      if (page === 'cards') {
        initPlayer();
      }
      if (page === 'leaderboard') {
        updateLocalTop();
      }
    }

    function copyCoords() {
      navigator.clipboard.writeText('—Ä–æ–∑–æ–≤–∞—è –≤–µ—Ç–∫–∞:1700');
      Telegram.WebApp.showAlert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
    }
  </script>
</body>
</html>
